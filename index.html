<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EconoGrow - Mi Dashboard Financiero</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      color: #1e293b;
      line-height: 1.6;
    }

    /* Fuentes para tÃ­tulos y botones */
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Poppins:wght@600&display=swap');

    .header {
      background: white;
      padding: 1rem 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* TÃ­tulos principales */
    h1,
    .main-title,
    .chart-title,
    #chartTitle {
      font-family: 'Montserrat', 'Poppins', 'Segoe UI', sans-serif;
      font-weight: 700;
      font-size: 2.3rem;
      letter-spacing: -1px;
      color: #1e293b;
      margin-bottom: 0.7em;
    }

    /* SubtÃ­tulos o tÃ­tulos de secciÃ³n */
    h2,
    h3,
    .section-title,
    .card-title {
      font-family: 'Montserrat', 'Poppins', 'Segoe UI', sans-serif;
      font-weight: 600;
      font-size: 1.5rem;
      color: #334155;
      margin-bottom: 0.5em;
    }

    /* Botones principales */
    .filter-btn,
    .main-btn,
    button {
      font-family: 'Montserrat', 'Poppins', 'Segoe UI', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      border-radius: 0.7em;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 0.5em;
      padding: 0.85em 1.5em;
    }

    .filter-btn>span,
    .main-btn>span,
    button>span {
      display: flex;
      align-items: center;
      justify-content: center;
    }


    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .main-logo {
      display: block;
      margin: 0 auto;
      max-width: 340px;
      width: 100%;
      height: auto;
      padding: 10px 0 10px 0;
    }

    .main {
      padding: 2rem 0;
    }

    .dashboard-title {
      text-align: center;
      margin-bottom: 2rem;
    }

    .dashboard-title h1 {
      font-size: 2rem;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .dashboard-title p {
      color: #64748b;
    }

    .filters {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: white;
      border: 2px solid #e2e8f0;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .filter-btn:hover {
      border-color: #2563eb;
    }

    .filter-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .chart-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      text-align: center;
      color: #1e293b;
    }

    .chart-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 400px;
    }

    #chart {
      width: 360px !important;
      height: 360px !important;
      max-width: 100%;
      max-height: 360px;
      display: block;
      margin: 0 auto;
    }

    .legend-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-start;
      margin-top: 1.5rem;
    }

    .legend-card {
      background: #f8fafc;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      padding: 0.4rem 0.8rem;
      display: flex;
      align-items: center;
      min-width: 120px;
      font-size: 0.98rem;
      gap: 0.5rem;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      display: inline-block;
      margin-right: 8px;
      border: 1.5px solid #e2e8f0;
    }

    .amount.negative {
      color: #e11d48 !important;
      font-weight: bold;
    }

    .amount.positive {
      color: #059669 !important;
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #64748b;
      font-size: 0.9rem;
    }

    .data-table {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    .table-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1e293b;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
    }

    .amount {
      font-weight: 600;
    }

    .amount.positive {
      color: #10b981;
    }

    .amount.negative {
      color: #ef4444;
    }

    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: center;
      }

      .filter-btn {
        width: 100%;
        max-width: 300px;
      }

      .chart-container {
        min-height: 300px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .header-content {
        flex-direction: column;
        gap: 0.5rem;
      }

      /* Oculta columna categoria en tabla detalle en mÃ³vil */
      .col-categoria {
        display: none !important;
      }
    }
  </style>
</head>

<body>

  <main class="main">
    <img src="logo.png" alt="EconoGrow logo" class="main-logo">
    <div class="container">

      <div class="filters">
        <button class="filter-btn active" data-filter="currentMonth">
          ðŸ“Š Este Mes
        </button>
        <button class="filter-btn" data-filter="kakeboAnalysis">
          ðŸŽ¯ Necesidades vs Deseos
        </button>
        <button class="filter-btn" data-filter="weeklyControl">
          ðŸ“… Ãšltimos 7 DÃ­as
        </button>
      </div>

      <div class="chart-section">
        <h2 class="chart-title" id="chartTitle">Gastos del Mes Actual</h2>
        <div class="chart-container">
          <canvas id="chart" width="360" height="360"></canvas>
          <div id="chartLegend"></div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat1">$1,245</div>
          <div class="stat-label" id="stat1Label">Total Gastado</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat2">5</div>
          <div class="stat-label" id="stat2Label">CategorÃ­as</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat3">$755</div>
          <div class="stat-label" id="stat3Label">Presupuesto Restante</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat4">62%</div>
          <div class="stat-label" id="stat4Label">Progreso</div>
        </div>
      </div>

      <div class="data-table">
        <h2 class="table-title" id="tableTitle">Detalle de Gastos</h2>
        <table id="dataTable">
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="col-categoria">CategorÃ­a</th>
              <th>DescripciÃ³n</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    function getMonthNameSpanish(monthIndex) {
      const meses = [
        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
      ];
      return meses[monthIndex];
    }

    function getCurrentSheetName() {
      // Se comenta la fecha fija de la demo para usar la fecha real.
      const now = new Date(); // Usa la fecha y hora actual del sistema
      const mes = getMonthNameSpanish(now.getMonth());
      const anio = now.getFullYear();
      return `${mes}_${anio}`;
    }

    async function fetchGastosData() {
      const sheetName = getCurrentSheetName();
      const url = `https://n8n.iaexperience.com.ar/webhook/get-gastos?sheetName=${sheetName}`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Error al obtener datos');
        const rawData = await resp.json();
        if (!Array.isArray(rawData)) return null;

        const chartDataMap = {};
        let totalGastado = 0;
        let presupuestoMensual = 0;
        rawData.forEach(item => {
          // Solo sumar si es gasto
          if (item.tipo === "Gasto") {
            const cat = item.categoria_principal || "Otros";
            if (!chartDataMap[cat]) chartDataMap[cat] = 0;
            chartDataMap[cat] += Math.abs(Number(item.monto) || 0);
            totalGastado += Math.abs(Number(item.monto) || 0);
            if (item.presupuesto_mensual && item.presupuesto_mensual > 0) {
              presupuestoMensual = item.presupuesto_mensual;
            }
          }
        });
        // Paleta Tableau 20 (colores bien diferenciados)
        const palette = [
          '#4E79A7', '#F28E2B', '#E15759', '#76B7B2', '#59A14F',
          '#EDC948', '#B07AA1', '#FF9DA7', '#9C755F', '#BAB0AC',
          '#86BCB6', '#F1CE63', '#D37295', '#FABFD2', '#B6992D',
          '#499894', '#E15759', '#79706E', '#D7B5A6', '#A5C8E1'
        ];
        let sortedEntries = Object.entries(chartDataMap).sort((a, b) => b[1] - a[1]);
        const chartData = sortedEntries.map(([label, value], idx) => ({
          label,
          value,
          color: palette[idx % palette.length]
        }));

        // Stats
        const categoriasUnicas = Object.keys(chartDataMap).length;
        const progreso = (presupuestoMensual > 0)
          ? Math.round((totalGastado / presupuestoMensual) * 100)
          : 0;
        const stats = {
          stat1: { value: `$${totalGastado}`, label: "Total Gastado" },
          stat2: { value: `${categoriasUnicas}`, label: "CategorÃ­as" },
          stat3: { value: presupuestoMensual > 0 ? `$${presupuestoMensual}` : "-", label: "Presupuesto Mensual" },
          stat4: { value: `${progreso}%`, label: "Progreso del Mes" }
        };

        // Table data: adaptar los campos que usa la tabla
        const tableData = rawData.map(item => ({
          fecha: item.fecha ? item.fecha.split(" ")[0] : "-",
          categoria: item.categoria_principal || "-",
          descripcion: item.descripcion || item.notas || "-",
          monto: Number(item.monto) || 0,
          tipo: item.tipo || ''
        }));

        return { chartData, stats, tableData, rawData };
      } catch (e) {
        console.error('Error al obtener datos del webhook:', e);
        return null;
      }
    }
    const myFinancialData = {
      currentMonth: {
        title: "Gastos del Mes Actual",
        chartData: [],
        stats: {},
        tableData: []
      },
      kakeboAnalysis: {
        title: "AnÃ¡lisis Kakebo - Necesidades vs Deseos",
        chartData: [],
        stats: {},
        tableData: []
      },
      weeklyControl: {
        title: "Control Semanal - Ãšltimos 7 DÃ­as",
        chartData: [],
        stats: {},
        tableData: []
      }
    };


    let currentFilter = 'currentMonth';
    let canvas, ctx;

    function setupCanvas() {
      canvas = document.getElementById('chart');
      ctx = canvas.getContext('2d');

      // Asegura que el canvas sea cuadrado y responsivo
      const size = Math.min(canvas.parentElement.offsetWidth, 360);
      canvas.width = size;
      canvas.height = size;
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      canvas.style.maxWidth = '100%';
    }

    // Dibujar grÃ¡fico de torta
    function drawPieChart(data) {
      const size = Math.min(canvas.width, canvas.height);
      const centerX = size / 2;
      const centerY = size / 2;
      const radius = size / 2 - 20;

      const total = data.reduce((sum, item) => sum + item.value, 0);
      let currentAngle = -Math.PI / 2;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Dibujar segmentos y porcentajes
      data.forEach((item) => {
        const sliceAngle = (item.value / total) * 2 * Math.PI;

        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = item.color;
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Porcentaje en el centro de la porciÃ³n
        const midAngle = currentAngle + sliceAngle / 2;
        const percent = ((item.value / total) * 100).toFixed(1);
        const labelX = centerX + Math.cos(midAngle) * (radius * 0.65);
        const labelY = centerY + Math.sin(midAngle) * (radius * 0.65);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        if (item.value / total > 0.04) {
          ctx.fillText(`${percent}%`, labelX, labelY);
        }

        currentAngle += sliceAngle;
      });
      ctx.textAlign = 'left';
      ctx.textBaseline = 'alphabetic';
    }

    // Renderiza la leyenda en tarjetas debajo del grÃ¡fico
    function renderLegend(data) {
      let legendHTML = '<div class="legend-list">';
      data.forEach(item => {
        const percent = ((item.value / data.reduce((sum, i) => sum + i.value, 0)) * 100).toFixed(1);
        legendHTML += `<div class="legend-card">
          <span class="legend-color" style="background:${item.color}"></span>
          <span><b>${item.label}</b>: $${item.value.toLocaleString('es-AR')} (${percent}%)</span>
        </div>`;
      });
      legendHTML += '</div>';
      // Busca el contenedor debajo del canvas
      let legendContainer = document.getElementById('chartLegend');
      if (!legendContainer) {
        legendContainer = document.createElement('div');
        legendContainer.id = 'chartLegend';
        canvas.parentElement.appendChild(legendContainer);
      }
      legendContainer.innerHTML = legendHTML;
    }

    // Actualizar estadÃ­sticas
    function updateStats(stats) {
      Object.keys(stats).forEach(key => {
        const valueEl = document.getElementById(key.replace('stat', 'stat'));
        const labelEl = document.getElementById(key + 'Label');
        if (valueEl && labelEl) {
          let val = stats[key].value;
          // Formatea con punto si es nÃºmero (y no porcentaje)
          if (typeof val === 'string' && val.match(/^\$?\d+(,\d+)?$/)) {
            val = val.replace('$', '');
            val = Number(val).toLocaleString('es-AR');
            valueEl.textContent = `$${val}`;
          } else if (typeof val === 'string' && val.match(/^\d+%$/)) {
            valueEl.textContent = val;
          } else if (!isNaN(val)) {
            valueEl.textContent = Number(val).toLocaleString('es-AR');
          } else {
            valueEl.textContent = val;
          }
          labelEl.textContent = stats[key].label;
        }
      });
    }

    // Actualizar tabla
    function updateTable(tableData, title) {
      document.getElementById('tableTitle').textContent = title;
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      tableData.forEach(row => {
        const tr = document.createElement('tr');
        // Extraer solo el dÃ­a de la fecha
        let day = '-';
        if (row.fecha && typeof row.fecha === 'string') {
          const match = row.fecha.match(/\d{4}-\d{2}-(\d{2})/);
          if (match) day = match[1];
        }
        // Detectar tipo para color
        let tipo = (row.tipo || '').toLowerCase();
        let amountClass = '';
        if (tipo === 'gasto') {
          amountClass = 'negative';
        } else if (tipo === 'ingreso') {
          amountClass = 'positive';
        }
        tr.innerHTML = `
          <td>${day}</td>
          <td class="col-categoria">${row.categoria}</td>
          <td>${row.descripcion}</td>
          <td class="amount ${amountClass}">$${Math.abs(row.monto)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Cambiar filtro
    function changeFilter(filter) {
      currentFilter = filter;
      const data = myFinancialData[filter];

      // Actualizar tÃ­tulo
      document.getElementById('chartTitle').textContent = data.title;

      // Actualizar botones
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

      // Limpiar leyenda previa
      let legendContainer = document.getElementById('chartLegend');
      if (legendContainer) legendContainer.innerHTML = '';

      // Dibujar grÃ¡fico
      if (filter === 'kakeboAnalysis') {
        drawPieChart(data.chartData);
        renderLegend(data.chartData);
        // Oculta cualquier leyenda extra fuera del canvas
        setTimeout(() => {
          document.querySelectorAll('#chartLegend').forEach(el => {
            if (el.parentElement && !el.closest('.chart-container')) {
              el.remove();
            }
          });
        }, 0);
      } else if (filter === 'weeklyControl') {
        drawPieChart(data.chartData);
        renderLegend(data.chartData);
      } else {
        drawPieChart(data.chartData);
        if (currentFilter === 'currentMonth') renderLegend(data.chartData);
      }

      // Actualizar stats y tabla
      // Ocultar/mostrar tarjetas segÃºn filtro
      updateStats(data.stats);
      // Oculta la tabla de detalle en Kakebo
      const tableSection = document.querySelector('.data-table');
      const tableTitle = document.getElementById('tableTitle');
      // Oculta stats no deseados en 'currentMonth'
      document.querySelectorAll('.stat-card').forEach(card => card.style.display = '');

      if (filter === 'currentMonth') {
        // Ocultar las tarjetas de stats que no corresponden a la vista mensual
        if (document.getElementById('stat2')) document.getElementById('stat2').parentElement.style.display = 'none';
        if (document.getElementById('stat3')) document.getElementById('stat3').parentElement.style.display = 'none';
      }
      if (filter === 'kakeboAnalysis') {
        if (tableSection) tableSection.style.display = 'none';
        if (tableTitle) tableTitle.style.display = 'none';
      } else {
        if (tableSection) tableSection.style.display = '';
        if (tableTitle) tableTitle.style.display = '';
        updateTable(data.tableData, `Detalle - ${data.title}`);
      }
    }

    // Inicializar todo
    document.addEventListener('DOMContentLoaded', async function () {
      setupCanvas();

      // Obtener datos del webhook y actualizar myFinancialData
      const data = await fetchGastosData();
      if (data) {
        // Datos del mes actual
        myFinancialData.currentMonth.chartData = data.chartData || [];
        myFinancialData.currentMonth.stats = data.stats || {};
        myFinancialData.currentMonth.tableData = data.tableData || [];

        // --- Kakebo: Necesidades vs Deseos ---
        // Agrupar por categoria_kakebo usando los datos originales del sheet
        const kakeboMap = {};
        let totalKakebo = 0;
        if (data.rawData) {
          data.rawData.forEach(item => {
            const cat = item.categoria_kakebo || "Otros";
            if (!kakeboMap[cat]) kakeboMap[cat] = 0;
            kakeboMap[cat] += Math.abs(Number(item.monto) || 0);
            totalKakebo += Math.abs(Number(item.monto) || 0);
          });
        }
        const kakeboColors = [
          "#2563eb", // azul fuerte
          "#f59e0b", // naranja
          "#10b981", // verde
          "#ef4444", // rojo
          "#8b5cf6", // violeta
          "#a16207", // marrÃ³n
          "#e11d48", // rosa fuerte
          "#0ea5e9"  // celeste
        ];
        let colorIdx = 0;
        myFinancialData.kakeboAnalysis.chartData = Object.entries(kakeboMap).map(([label, value]) => ({
          label,
          value,
          color: kakeboColors[colorIdx++ % kakeboColors.length]
        }));
        // Stats Kakebo: porcentaje por categorÃ­a
        myFinancialData.kakeboAnalysis.stats = {};
        Object.entries(kakeboMap).forEach(([label, value], idx) => {
          myFinancialData.kakeboAnalysis.stats[`stat${idx + 1}`] = {
            value: totalKakebo > 0 ? `${Math.round((value / totalKakebo) * 100)}%` : "0%",
            label
          }
        });
        myFinancialData.kakeboAnalysis.tableData = (data.rawData || []).map(item => ({
          fecha: item.fecha ? item.fecha.split(" ")[0] : "-",
          categoria: item.categoria_kakebo || "-",
          descripcion: item.descripcion || item.notas || "-",
          monto: Number(item.monto) || 0
        }));

        // --- Ãšltimos 7 dÃ­as ---
        const now = new Date(); // Usa la fecha y hora actual del sistema
        // Calcular el rango: desde hoy hasta 6 dÃ­as atrÃ¡s
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const minDate = new Date(Math.max(startOfMonth.getTime(), now.getTime() - 6 * 24 * 60 * 60 * 1000));
        const last7Days = data.tableData.filter(row => {
          const d = new Date(row.fecha);
          return !isNaN(d) && d >= minDate && d <= now;
        });
        // Agrupar por categoria_principal
        // Filtra solo gastos
        const semanaMap = {};
        let totalSemana = 0;
        const coloresSemana = [
          "#2563eb", "#f59e0b", "#10b981", "#ef4444", "#8b5cf6", "#a16207", "#e11d48", "#0ea5e9", "#64748b", "#be185d", "#0f766e", "#f43f5e"
        ];
        let colorIdxSemana = 0;
        last7Days.filter(row => (row.tipo || '').toLowerCase() === 'gasto').forEach(row => {
          const cat = row.categoria || "Otros";
          if (!semanaMap[cat]) semanaMap[cat] = 0;
          semanaMap[cat] += Math.abs(Number(row.monto) || 0);
          totalSemana += Math.abs(Number(row.monto) || 0);
        });
        const catsSemana = Object.keys(semanaMap);
        myFinancialData.weeklyControl.chartData = catsSemana.map((label, idx) => ({
          label,
          value: semanaMap[label],
          color: coloresSemana[idx % coloresSemana.length]
        }));
        // Stats semanal
        // Obtiene presupuesto_semanal y gastos_del_mes del primer elemento del webhook
        const primerElemento = (data.rawData && data.rawData.length > 0) ? data.rawData[0] : {};
        const presupuestoSemanal = primerElemento.presupuesto_semanal || '-';
        const gastosDelMes = primerElemento.gasto_mensual || '-';
        const presupuestoMensual = primerElemento.presupuesto_mensual || '-';
        myFinancialData.weeklyControl.stats = {
          stat1: { value: `$${Math.round(totalSemana)}`, label: "Gasto Semanal" },
          stat2: { value: `$${Math.round(totalSemana / 7)}`, label: "Promedio Diario" },
          stat3: { value: presupuestoSemanal !== '-' ? `$${Math.round(Number(presupuestoSemanal))}` : '-', label: "Presupuesto Semanal" },
          stat4: { value: presupuestoMensual !== '-' ? `$${Math.round(Number(presupuestoMensual))}` : '-', label: "Presupuesto Mensual" }
        };
        // Para secciÃ³n "Este Mes": solo mostrar presupuesto mensual y gastos del mes
        myFinancialData.currentMonth.stats = {
          stat1: { value: gastosDelMes !== '-' ? `$${gastosDelMes}` : '-', label: "Gastos del Mes" },
          stat4: { value: presupuestoMensual !== '-' ? `$${presupuestoMensual}` : '-', label: "Presupuesto Mensual" }
        };

        myFinancialData.weeklyControl.tableData = last7Days;
      }

      // Event listeners para filtros
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          changeFilter(this.dataset.filter);
        });
      });

      // Cargar datos iniciales
      // Solo cambiar filtro si hay datos reales cargados
      if (data && data.rawData && data.rawData.length > 0) {
        changeFilter('currentMonth');
      } else {
        // Si no hay datos, limpia stats y grÃ¡ficos
        document.querySelectorAll('.stat-value').forEach(el => el.textContent = '-');
        document.querySelectorAll('.stat-label').forEach(el => el.textContent = '');
        if (canvas) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        let legendContainer = document.getElementById('chartLegend');
        if (legendContainer) legendContainer.innerHTML = '';
      }

      // Redimensionar en resize
      window.addEventListener('resize', function () {
        setTimeout(() => {
          changeFilter(currentFilter);
        }, 100);
      });
    });
  </script>
</body>

</html>